 Сеть в Kubernetes — одна из самых сложных, но и самых мощных его частей. Давайте разберем ее по уровням.

### Основные принципы (The Kubernetes Networking Model)

Kubernetes предъявляет к сети четыре фундаментальных требования:

1.  **Pod-to-Pod communication:** Все поды могут общаться со всеми подами на всех узлах кластера **без NAT**.
2.  **Pod-to-Service communication:** Все поды могут общаться со всеми сервисами на всех узлах (здесь уже может работать NAT, но это абстрагировано).
3.  **Host-to-Pod communication:** Узлы (ноды) могут общаться с подами на себе и на других узлах.
4.  **External-to-Service communication:** Внешние клиенты могут общаться с сервисами внутри кластера.

**Важно:** Сам Kubernetes не реализует сеть. Он предоставляет модель, а реализацию делегирует **CNI-плагинам**.

---

### 1. Сеть подов (Pod Network)

Это "оверлейная" сеть, которая связывает все поды кластера.

**Как регулируется?**
*   **CNI-плагин (Container Network Interface):** Выбирается при развертывании кластера. Плагин отвечает за создание сетевых пространств, выделение IP-адресов и настройку маршрутов.
    *   **Примеры популярных CNI:**
        *   **Calico:** Использует BGP-протокол для маршрутизации или может работать в режиме IP-in-IP.
        *   **Flannel:** Простой плагин, часто использует VXLAN для создания overlay-сети.
        *   **Cilium:** Мощный плагин на основе eBPF, предоставляет не только сеть, но и расширенные возможности безопасности и observability.
        *   **Weave Net:** Создает собственную mesh-сеть между узлами.

**Где настраивается?**
Настройки CNI-плагина обычно задаются в виде DaemonSet'ов или конфигурационных файлов на узлах (часто в `/etc/cni/net.d/`). При создании кластера (например, с помощью `kubeadm`, `kops` или в облачном провайдере) вы выбираете CNI-плагин и передаете ему параметры.

---

### 2. Сервисы (Services)

Сервис — это абстракция, которая предоставляет стабильную точку доступа к группе динамических подов.

**Как регулируется?**
*   **Тип Сервиса (Service Type):** Указывается в манифесте сервиса.
    *   `ClusterIP` (по умолчанию): Виден только внутри кластера. Выделяется виртуальный IP из пула `service-cluster-ip-range`.
    *   `NodePort`: Открывает статический порт на **каждой** ноде кластера. Трафик на `<NodeIP>:<NodePort>` перенаправляется в сервис.
    *   `LoadBalancer`: Интегрируется с облачным провайдером (AWS ELB, GCP Load Balancer и т.д.) чтобы создать внешний балансировщик нагрузки, который направляет трафик в сервис.
    *   `Headless` (без ClusterIP): Используется для прямого доступа к подам, когда DNS возвращает все IP подов.

*   **Селектор (Selector):** Ключевая часть манифеста сервиса. `selector: app: nginx` указывает, что сервис должен направлять трафик на поды с меткой `app: nginx`.

**Пример манифеста Service:**
```yaml
apiVersion: v1
kind: Service
metadata:
  name: my-nginx-service
spec:
  type: ClusterIP # Можно заменить на NodePort или LoadBalancer
  selector:
    app: nginx # Важно: этот селектор должен совпадать с метками ваших подов!
  ports:
    - protocol: TCP
      port: 80 # Порт, на котором сервис принимает запросы
      targetPort: 80 # Порт, на который перенаправлять трафик в поде
```

**Как это работает "под капотом"?**
За преобразование виртуального IP сервиса в реальные IP подов отвечает `kube-proxy`. Он работает на каждой ноде и может работать в разных режимах:
*   **iptables (по умолчанию):** Создает цепочки правил iptables для перенаправления трафика.
*   **ipvs:** Более эффективный режим для больших кластеров, использует механизм балансировки нагрузки в ядре Linux.

---

### 3. Ingress (Входная точка)

Ingress — это не тип сервиса, а отдельный API-объект, который управляет внешним доступом к сервисам по HTTP/HTTPS. Он предоставляет:
*   Виртуальные хосты (`host: example.com`)
*   Пути на основе URL (`path: /api`)
*   SSL-терминацию

**Как регулируется?**
*   **Ingress Controller:** Это **пода**, который работает в вашем кластере и следит за объектами Ingress. Он сам и реализует логику маршрутизации.
    *   **Примеры:** Nginx Ingress Controller, Traefik, HAProxy Ingress, Istio Ingress Gateway.
*   **Ingress Resource:** Манифест, который вы создаете, чтобы описать правила маршрутизации для Ingress Controller'а.

**Пример манифеста Ingress:**
```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: my-app-ingress
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: / # Аннотации специфичны для контроллера!
spec:
  tls:
    - hosts:
        - myapp.example.com
      secretName: myapp-tls-secret # Секрет с TLS-сертификатом
  rules:
    - host: myapp.example.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: my-nginx-service # Ссылаемся на существующий сервис
                port:
                  number: 80
```

---

### 4. Network Policies (Сетевые политики)

Это "брандмауэр" Kubernetes. Они контролируют, какой трафик разрешен между подами.

**Как регулируется?**
*   **Манифест NetworkPolicy:** Вы описываете, каким подам (по селекторам) разрешено общаться и с кем.

**Пример манифеста NetworkPolicy:**
Эта политика разрешает трафик к подам с меткой `role: db` только от подов с меткой `role: api`.
```yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: db-allow-only-from-api
spec:
  podSelector:
    matchLabels:
      role: db # Целевые поды, к которым применяется политика
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              role: api # Кто может инициировать соединение
      ports:
        - protocol: TCP
          port: 5432 # На какой порт
```

**Важно:** Для работы Network Policies ваш CNI-плагин должен их поддерживать (Calico, Cilium — поддерживают, Flannel — нет).

---

### Ключевые настройки на уровне кластера (для администраторов)

Эти параметры обычно задаются в конфигурации API-сервера (`kube-apiserver`) при инициализации кластера.

*   `--service-cluster-ip-range`: CIDR-диапазон, из которого выделяются виртуальные IP для сервисов типа `ClusterIP`. (Например, `10.96.0.0/12`).
*   `--pod-network-cidr`: CIDR-диапазон для сети подов. Этот параметр передается CNI-плагину. (Например, `10.244.0.0/16`).

### Резюме и общая схема работы

1.  **Внешний пользователь** обращается по URL `myapp.example.com`.
2.  **DNS** возвращает IP вашего Ingress Controller'а (например, внешний IP облачного балансировщика).
3.  **Ingress Controller** (например, Nginx) получает запрос, смотрит на хост и путь, находит по ним правило в Ingress-ресурсе и перенаправляет трафик на соответствующий **Service** (например, `my-nginx-service:80`).
4.  **Service** имеет виртуальный IP (например, `10.96.1.5`). `kube-proxy` на нодах с помощью iptables/ipvs преобразует этот IP в один из реальных IP **Pod'ов** (например, `10.244.1.2`).
5.  **Сеть подов**, управляемая CNI-плагином (например, Calico), доставляет пакет на нужную ноду и в нужный под.
6.  **Network Policies** (если есть) проверяют на каждом шаге, разрешено ли данное соединение.